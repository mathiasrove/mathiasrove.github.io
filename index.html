<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>C√¶tty og Rove's Tom Waits l√∏pet 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0a07;
    --card: #1a1410;
    --border: #3d2e1e;
    --gold: #c9973a;
    --cream: #f0e6d3;
    --muted: #7a6a56;
    --red: #c0392b;
    --green: #2ecc71;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--cream); font-family: 'DM Mono', monospace; min-height: 100vh; padding-bottom: 80px; }
  body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9999; opacity: 0.4; }
  header { padding: 20px 20px 14px; text-align: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px); background: rgba(13,10,7,0.92); }
  header h1 { font-family: 'Playfair Display', serif; font-size: 1.2rem; color: var(--gold); font-style: italic; line-height: 1.3; }
  header p { color: var(--muted); font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; margin-top: 4px; }
  .tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg); }
  .tab { flex: 1; padding: 12px 4px; text-align: center; cursor: pointer; font-size: 0.6rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid transparent; transition: all 0.2s; }
  .tab.active { color: var(--gold); border-bottom-color: var(--gold); }
  .section { display: none; padding: 16px; }
  .section.active { display: block; }

  /* Bar cards */
  .bar-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
  .bar-card.visited { border-color: var(--gold); }
  .bar-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
  .bar-num { background: var(--gold); color: var(--bg); font-weight: 500; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; flex-shrink: 0; margin-top: 2px; }
  .bar-num.done { background: var(--muted); }
  .bar-info { flex: 1; }
  .bar-name { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--cream); font-style: italic; }
  .bar-addr { font-size: 0.65rem; color: var(--muted); margin-top: 2px; }
  .visit-btn { width: 100%; margin-top: 12px; padding: 10px; border-radius: 8px; border: 1px solid var(--gold); background: transparent; color: var(--gold); font-family: 'DM Mono', monospace; font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
  .visit-btn:active { background: var(--gold); color: var(--bg); }
  .visit-btn.visited-btn { border-color: var(--muted); color: var(--muted); }

  /* Bar challenges log */
  .bar-challenges { margin-top: 12px; }
  .bar-challenges-title { font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
  .challenge-log-row { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; background: var(--bg); margin-bottom: 6px; }
  .challenge-log-player { font-size: 0.7rem; width: 64px; flex-shrink: 0; }
  .challenge-log-text { font-size: 0.65rem; color: var(--muted); flex: 1; line-height: 1.4; }
  .challenge-log-pts { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold); min-width: 28px; text-align: right; }
  .challenge-log-pts.zero { color: var(--muted); }
  .bar-total-row { display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
  .bar-total-chip { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 8px; text-align: center; }
  .bar-total-chip-name { font-size: 0.6rem; color: var(--muted); margin-bottom: 2px; }
  .bar-total-chip-pts { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--gold); }

  /* Bar personal rating */
  .bar-rating-section { margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); }
  .bar-rating-title { font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
  .player-rating-row { display: flex; align-items: center; gap: 8px; margin-bottom: 7px; }
  .player-rating-name { font-size: 0.7rem; color: var(--cream); width: 64px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .rating-stars { display: flex; gap: 2px; }
  .rating-star { width: 22px; height: 22px; border-radius: 4px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 9px; color: var(--muted); transition: all 0.12s; background: transparent; }
  .rating-star.filled { background: var(--gold); border-color: var(--gold); color: var(--bg); }
  .rating-num { font-size: 0.85rem; color: var(--gold); min-width: 18px; text-align: right; }

  /* Scoreboard */
  .scoreboard { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
  .sb-header { background: var(--gold); color: var(--bg); padding: 12px 16px; font-family: 'Playfair Display', serif; font-size: 1rem; font-style: italic; }
  .sb-row { display: flex; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--border); gap: 12px; }
  .sb-row:last-child { border-bottom: none; }
  .sb-rank { font-size: 0.7rem; color: var(--muted); width: 24px; }
  .sb-player-name { flex: 1; font-size: 0.85rem; }
  .sb-total { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--gold); }
  .sb-sub { font-size: 0.6rem; color: var(--muted); text-align: right; min-width: 60px; }
  .progress-bar-wrap { background: var(--border); border-radius: 4px; height: 4px; margin-bottom: 4px; overflow: hidden; }
  .progress-bar-fill { height: 100%; background: var(--gold); border-radius: 4px; transition: width 0.4s ease; }
  .progress-text { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.1em; margin-bottom: 16px; text-align: center; }
  .winner-banner { background: linear-gradient(135deg, #c9973a, #8b5e1e); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 16px; }
  .winner-banner h2 { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: var(--bg); font-style: italic; }
  .winner-banner p { color: rgba(0,0,0,0.6); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; margin-top: 4px; }

  /* Map */
  .map-btn { display: flex; width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--cream); font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; text-decoration: none; margin-bottom: 10px; align-items: center; gap: 10px; }
  .map-btn:active { background: var(--border); }
  .map-icon { font-size: 1.2rem; }
  .map-info { text-align: left; }
  .map-title { color: var(--cream); }
  .map-sub { color: var(--muted); font-size: 0.6rem; margin-top: 2px; }

  /* Settings */
  .settings-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
  .settings-title { font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }
  .player-input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  input[type="text"] { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; color: var(--cream); font-family: 'DM Mono', monospace; font-size: 0.8rem; outline: none; transition: border-color 0.2s; }
  input[type="text"]:focus { border-color: var(--gold); }
  .save-btn { width: 100%; padding: 12px; border-radius: 8px; border: none; background: var(--gold); color: var(--bg); font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.15em; text-transform: uppercase; cursor: pointer; font-weight: 500; }
  .reset-btn { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--red); background: transparent; color: var(--red); font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.15em; text-transform: uppercase; cursor: pointer; margin-top: 8px; }

  /* Wheel */
  .wheel-wrap { display: flex; flex-direction: column; align-items: center; padding: 8px 0 24px; }
  .wheel-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
  .wheel-pointer { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 2rem; z-index: 10; }
  #spin-canvas { border-radius: 50%; box-shadow: 0 0 40px rgba(201,151,58,0.3), 0 0 0 4px var(--gold); }
  .spin-btn { margin-top: 24px; padding: 16px 48px; border-radius: 50px; border: none; background: var(--gold); color: var(--bg); font-family: 'DM Mono', monospace; font-size: 0.8rem; letter-spacing: 0.15em; text-transform: uppercase; cursor: pointer; font-weight: 500; box-shadow: 0 4px 20px rgba(201,151,58,0.4); transition: transform 0.1s; }
  .spin-btn:active { transform: scale(0.96); }
  .spin-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .wheel-note { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; margin-top: 12px; text-align: center; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.88); backdrop-filter: blur(6px); align-items: center; justify-content: center; padding: 24px; }
  .modal-overlay.open { display: flex; }
  .modal-box { background: var(--card); border: 1px solid var(--gold); border-radius: 20px; padding: 28px 20px; text-align: center; max-width: 340px; width: 100%; animation: popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275); }
  @keyframes popIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .modal-pts-badge { display: inline-block; background: var(--gold); color: var(--bg); border-radius: 20px; padding: 4px 14px; font-size: 0.75rem; letter-spacing: 0.1em; margin-bottom: 16px; font-weight: 500; }
  .difficulty-label { font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 4px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
  .modal-btn { flex: 1; padding: 14px; border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase; cursor: pointer; font-weight: 500; border: none; }
  .modal-btn.yes { background: var(--green); color: #0a1f0f; }
  .modal-btn.no { background: var(--bg); border: 1px solid var(--border); color: var(--muted); }
</style>
</head>
<body>

<header>
  <h1>C√¶tty og Rove's<br>Tom Waits l√∏pet 2026 üç∫</h1>
  <p id="header-sub">T√∏nsberg ¬∑ 0/6 barer</p>
</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('bars')">Barer</div>
  <div class="tab" onclick="showTab('score')">Score</div>
  <div class="tab" onclick="showTab('wheel')">üé° Hjul</div>
  <div class="tab" onclick="showTab('map')">Kart</div>
  <div class="tab" onclick="showTab('settings')">‚öôÔ∏è</div>
</div>

<div id="tab-bars" class="section active"></div>
<div id="tab-score" class="section"></div>
<div id="tab-wheel" class="section"></div>
<div id="tab-map" class="section"></div>
<div id="tab-settings" class="section"></div>

<!-- Challenge Modal -->
<div class="modal-overlay" id="result-modal">
  <div class="modal-box">
    <div id="modal-emoji" style="font-size:2.8rem;margin-bottom:6px"></div>
    <div id="modal-name" style="font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--gold);font-style:italic;margin-bottom:12px"></div>
    <div id="modal-difficulty" class="difficulty-label"></div>
    <div id="modal-pts-badge" class="modal-pts-badge"></div>
    <div id="modal-challenge" style="font-size:0.95rem;color:var(--cream);line-height:1.6;margin-top:14px;padding:14px;background:var(--bg);border-radius:10px;border:1px solid var(--border);text-align:left"></div>
    <div class="modal-actions">
      <button class="modal-btn no" onclick="recordResult(false)">‚ùå Nektet</button>
      <button class="modal-btn yes" onclick="recordResult(true)">‚úÖ Gjennomf√∏rt!</button>
    </div>
  </div>
</div>

<script>
const BARS = [
  { name: "Mytteriet", addr: "Nedre Langgate 26A", lat: 59.2665258, lng: 10.4062956 },
  { name: "Big Ben", addr: "Torvet 1", lat: 59.2676903, lng: 10.4085126 },
  { name: "Black and White", addr: "Kammegaten 11", lat: 59.2687735, lng: 10.4084762 },
  { name: "Lille Havariet", addr: "Nedre Langgate 30E", lat: 59.2663088, lng: 10.4052936 },
  { name: "Foyn", addr: "Nedre Langgate 18C", lat: 59.265325, lng: 10.4069444 },
  { name: "Paparazzi", addr: "Nedre Langgate 20", lat: 59.26584, lng: 10.4063605 },
];
const EMOJIS = ['üç∫', 'ü•Ç', 'üç∏'];
const STORAGE_KEY = 'caetty-rove-tomwaits-2026';

// difficulty: 1=Easy (1pt), 2=Medium (2pt), 3=Hard (3pt)
const CHALLENGES = [
  { emoji: 'üç∫', text: 'Ta en slurk for hvert √•r du har v√¶rt venn med de andre to.', diff: 1, pts: 1 },
  { emoji: 'ü•Ç', text: 'Sk√•l med alle i baren innen 2 minutter ‚Äî ellers drikker du ut glasset.', diff: 2, pts: 2 },
  { emoji: 'üçπ', text: 'Bestill en drink du aldri har smakt f√∏r.', diff: 1, pts: 1 },
  { emoji: 'üç∫', text: 'Drikk med feil h√•nd resten av baren. Tar du feil h√•nd, drikker du en slurk.', diff: 2, pts: 2 },
  { emoji: 'ü•É', text: 'Ta to slurker og si en sk√•l ‚Äî p√• et annet spr√•k enn norsk.', diff: 1, pts: 1 },
  { emoji: 'üçª', text: 'Bytt drink med personen til h√∏yre for deg i √©n runde.', diff: 1, pts: 1 },
  { emoji: 'üç∫', text: 'Ta en slurk hver gang noen sier "sk√•l" resten av kvelden p√• denne baren.', diff: 2, pts: 2 },
  { emoji: 'ü•Ç', text: 'Drikk sittende p√• huk til du er ferdig med slurken.', diff: 1, pts: 1 },
  { emoji: 'üé§', text: 'Syng refrenget til en sang ‚Äî de andre velger sangen.', diff: 2, pts: 2 },
  { emoji: 'üí¨', text: 'G√• bort til en fremmed og sp√∏r om deres beste drikketips.', diff: 2, pts: 2 },
  { emoji: 'üï∫', text: 'Dans alene i 15 sekunder, uten musikk.', diff: 2, pts: 2 },
  { emoji: 'üì∏', text: 'Ta en selfie med en fremmed og vis den frem til gruppen.', diff: 2, pts: 2 },
  { emoji: 'ü§ù', text: 'Presenter deg til barpersonalet med et falskt, overdrevet yrke.', diff: 2, pts: 2 },
  { emoji: 'üó£Ô∏è', text: 'Fortell en vits for gruppa. Er den d√•rlig, drikker du en ekstra slurk.', diff: 1, pts: 1 },
  { emoji: 'üé≠', text: 'Etterlign en kjent person i 30 sekunder ‚Äî de andre gjetter hvem.', diff: 2, pts: 2 },
  { emoji: 'ü§´', text: 'Si ingenting i 3 minutter. Bryter du tausheten, drikker du.', diff: 3, pts: 3 },
  { emoji: 'üé≤', text: 'Ring en som ikke er med i kveld og overbevis dem om √• bli med. Klarer du det? Du slipper neste utfordring.', diff: 3, pts: 3 },
  { emoji: 'üëë', text: 'Du er "Kongen/Dronningen" resten av baren ‚Äî de andre m√• gj√∏re det du sier (innen rimelighetens grenser).', diff: 3, pts: 3 },
  { emoji: 'üå∂Ô∏è', text: 'Fortell den mest pinlige tingen du har gjort p√• en bar ‚Äî eller drikk dobbelt.', diff: 2, pts: 2 },
  { emoji: '‚è±Ô∏è', text: 'Hold pusten s√• lenge du kan. Antall sekunder = antall slurker DE ANDRE drikker.', diff: 2, pts: 2 },
  { emoji: 'üÉè', text: 'Sannhet eller utfordring? Velg en av de andre til √• stille deg sp√∏rsm√•let.', diff: 2, pts: 2 },
  { emoji: 'üîÅ', text: 'Bytt plass med en av de andre og bli sittende slik til neste bar.', diff: 1, pts: 1 },
  { emoji: 'üéØ', text: 'Gruppen klipper-saks-stein. Taperen drikker en ekstra slurk.', diff: 1, pts: 1 },
  { emoji: 'üïµÔ∏è', text: 'Finn noe dere alle tre har til felles med noen i baren ‚Äî og fortell dem det.', diff: 3, pts: 3 },
];

const DIFF_LABEL = { 1: '‚≠ê Lett', 2: '‚≠ê‚≠ê Middels', 3: '‚≠ê‚≠ê‚≠ê Vanskelig' };
const DIFF_COLOR = { 1: '#7a6a56', 2: '#c9973a', 3: '#e05a2b' };

let state = load();
let wheelSpinning = false;
let wheelAngle = 0;
let pendingResult = null; // { playerIdx, challenge, barIdx }

function load() {
  try {
    const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
    if (s) {
      // Migrate old saves that lack barRatings
      if (!s.barRatings) s.barRatings = BARS.map(() => [null, null, null]);
      return s;
    }
  } catch(e) {}
  return {
    players: ['C√¶tty', 'Rove', 'Spiller 3'],
    visited: BARS.map(() => false),
    // challengeLog: array of { barIdx, playerIdx, challenge text, pts, done }
    challengeLog: [],
    barRatings: BARS.map(() => [null, null, null]),
  };
}

function save() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {}
}

function showTab(name) {
  const names = ['bars','score','wheel','map','settings'];
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', names[i] === name));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'bars') renderBars();
  if (name === 'score') renderScore();
  if (name === 'wheel') renderWheel();
  if (name === 'map') renderMap();
  if (name === 'settings') renderSettings();
}

// ---- BARS ----
function getBarPoints(bi, pi) {
  return state.challengeLog
    .filter(e => e.barIdx === bi && e.playerIdx === pi && e.done)
    .reduce((sum, e) => sum + e.pts, 0);
}

function getBarLog(bi) {
  return state.challengeLog.filter(e => e.barIdx === bi);
}

function renderBars() {
  const visited = state.visited.filter(Boolean).length;
  const el = document.getElementById('tab-bars');
  // Find current bar (first visited that we're "at") ‚Äî just show all visited
  let html = `
    <div class="progress-text">${visited} av ${BARS.length} barer bes√∏kt</div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${(visited/BARS.length)*100}%"></div></div>
    <div style="margin-bottom:16px"></div>
  `;

  BARS.forEach((bar, bi) => {
    const v = state.visited[bi];
    const log = getBarLog(bi);
    html += `<div class="bar-card ${v ? 'visited' : ''}">
      <div class="bar-header">
        <div class="bar-num ${v ? 'done' : ''}">${bi+1}</div>
        <div class="bar-info">
          <div class="bar-name">${bar.name}</div>
          <div class="bar-addr">${bar.addr}</div>
        </div>
        ${v ? '<div style="font-size:1rem;margin-left:auto">‚úÖ</div>' : ''}
      </div>`;

    if (v && log.length > 0) {
      html += `<div class="bar-challenges">
        <div class="bar-challenges-title">Utfordringer her</div>`;
      log.forEach(e => {
        html += `<div class="challenge-log-row">
          <div class="challenge-log-player">${EMOJIS[e.playerIdx]} ${state.players[e.playerIdx]}</div>
          <div class="challenge-log-text">${e.emoji} ${e.text}</div>
          <div class="challenge-log-pts ${e.done ? '' : 'zero'}">${e.done ? '+'+e.pts : '‚Äî'}</div>
        </div>`;
      });
      // Totals per player
      html += `<div class="bar-total-row">`;
      state.players.forEach((p, pi) => {
        const pts = getBarPoints(bi, pi);
        html += `<div class="bar-total-chip">
          <div class="bar-total-chip-name">${EMOJIS[pi]} ${p}</div>
          <div class="bar-total-chip-pts">${pts}p</div>
        </div>`;
      });
      html += `</div></div>`;
    }

    if (v) {
      // Personal bar ratings
      html += `<div class="bar-rating-section">
        <div class="bar-rating-title">Min vurdering av baren</div>`;
      state.players.forEach((p, pi) => {
        const sc = state.barRatings[bi][pi];
        html += `<div class="player-rating-row">
          <div class="player-rating-name">${EMOJIS[pi]} ${p}</div>
          <div class="rating-stars" id="brating-${bi}-${pi}">`;
        for (let s = 1; s <= 10; s++) {
          html += `<div class="rating-star ${sc !== null && s <= sc ? 'filled' : ''}" onclick="setBarRating(${bi},${pi},${s})">${s}</div>`;
        }
        html += `</div><div class="rating-num" id="bratingnum-${bi}-${pi}">${sc !== null ? sc : '‚Äî'}</div></div>`;
      });
      // Average rating
      const ratings = state.barRatings[bi].filter(r => r !== null);
      if (ratings.length > 0) {
        const avg = (ratings.reduce((a,b) => a+b, 0) / ratings.length).toFixed(1);
        html += `<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:flex;align-items:baseline;gap:8px">
          <span style="font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted)">Snittkarakter</span>
          <span style="font-family:'Playfair Display',serif;font-size:1.6rem;color:var(--gold)">${avg}</span>
          <span style="font-size:0.65rem;color:var(--muted)">/ 10</span>
        </div>`;
      }

      html += `</div>`;

      html += `<button class="visit-btn visited-btn" onclick="toggleVisit(${bi})">Merk som ikke bes√∏kt</button>`;
    } else {
      html += `<button class="visit-btn" onclick="toggleVisit(${bi})">üç∫ Vi er her n√•!</button>`;
    }
    html += `</div>`;
  });

  el.innerHTML = html;
  document.getElementById('header-sub').textContent = `T√∏nsberg ¬∑ ${visited}/${BARS.length} barer`;
}

function toggleVisit(bi) {
  state.visited[bi] = !state.visited[bi];
  save();
  renderBars();
}

// ---- SCORE ----
function getTotalPoints(pi) {
  return state.challengeLog
    .filter(e => e.playerIdx === pi && e.done)
    .reduce((sum, e) => sum + e.pts, 0);
}

function renderScore() {
  const el = document.getElementById('tab-score');
  const visited = state.visited.filter(Boolean).length;

  const rankings = state.players.map((name, pi) => ({
    name, pi,
    total: getTotalPoints(pi),
    completed: state.challengeLog.filter(e => e.playerIdx === pi && e.done).length,
    attempted: state.challengeLog.filter(e => e.playerIdx === pi).length,
  })).sort((a,b) => b.total - a.total);

  let html = '';
  if (visited === BARS.length && rankings[0].total > 0) {
    html += `<div class="winner-banner"><h2>üèÜ Vinneren er ${rankings[0].name}!</h2><p>${rankings[0].total} poeng totalt</p></div>`;
  }

  // Only wheel challenge points
  html += `<div class="scoreboard"><div class="sb-header">Samlet poengsum ‚Äî hjulutfordringer</div>`;
  rankings.forEach((r, i) => {
    html += `<div class="sb-row">
      <div class="sb-rank">${i===0?'ü•á':i===1?'ü•à':'ü•â'}</div>
      <div class="sb-player-name">${EMOJIS[r.pi]} ${r.name}</div>
      <div class="sb-sub">${r.completed}/${r.attempted} gjennomf√∏rt</div>
      <div class="sb-total">${r.total}p</div>
    </div>`;
  });
  html += `</div>`;

  // Per bar wheel points breakdown
  html += `<div class="scoreboard"><div class="sb-header">Hjulpoeng per bar</div>`;
  const visitedBars = BARS.filter((_, bi) => state.visited[bi]);
  if (visitedBars.length === 0) {
    html += `<div class="sb-row"><div style="color:var(--muted);font-size:0.7rem">Ingen barer bes√∏kt enn√•</div></div>`;
  } else {
    BARS.forEach((bar, bi) => {
      if (!state.visited[bi]) return;
      html += `<div class="sb-row" style="flex-wrap:wrap;gap:6px">
        <div style="flex:1;font-family:'Playfair Display',serif;font-style:italic;font-size:0.9rem">${bar.name}</div>
        <div style="display:flex;gap:10px">
          ${state.players.map((p,pi) => `<span style="font-size:0.7rem;color:var(--muted)">${EMOJIS[pi]} ${getBarPoints(bi,pi)}p</span>`).join('')}
        </div>
      </div>`;
    });
  }
  html += `</div>`;

  el.innerHTML = html;
}

// ---- WHEEL ----
function renderWheel() {
  const visited = state.visited.filter(Boolean).length;
  const el = document.getElementById('tab-wheel');

  if (visited === 0) {
    el.innerHTML = `<div style="text-align:center;padding:60px 20px;color:var(--muted)">
      <div style="font-size:2rem;margin-bottom:12px">üç∫</div>
      <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--cream);font-style:italic">Bes√∏k en bar f√∏rst!</div>
      <div style="font-size:0.7rem;margin-top:8px">Merk en bar som bes√∏kt i Barer-fanen</div>
    </div>`;
    return;
  }

  // Current bar = last visited
  const currentBarIdx = state.visited.lastIndexOf(true);

  el.innerHTML = `
    <div class="wheel-wrap">
      <div style="font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:2px">N√• p√•</div>
      <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--cream);font-style:italic;margin-bottom:12px">${BARS[currentBarIdx].name}</div>
      <div style="font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Spin the wheel</div>
      <div style="font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--gold);font-style:italic;margin-bottom:4px">Hvem f√•r utfordringen?</div>
      <div class="wheel-container">
        <div class="wheel-pointer">üîª</div>
        <canvas id="spin-canvas" width="300" height="300"></canvas>
      </div>
      <button class="spin-btn" id="spin-btn" onclick="spinWheel(${currentBarIdx})">Spin! üé°</button>
      <div class="wheel-note">Hjulet velger spiller OG utfordring</div>
    </div>
  `;
  drawWheel(wheelAngle);
}

function drawWheel(angle) {
  const canvas = document.getElementById('spin-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const cx = 150, cy = 150, r = 145;
  const players = state.players;
  const n = players.length;
  const sliceAngle = (2 * Math.PI) / n;
  const palettes = [['#c9973a','#0d0a07'],['#1a1410','#c9973a'],['#5a3e1b','#f0e6d3']];
  ctx.clearRect(0, 0, 300, 300);
  players.forEach((name, i) => {
    const start = angle + i * sliceAngle - Math.PI / 2;
    const end = start + sliceAngle;
    const [fill, textColor] = palettes[i % palettes.length];
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, start, end); ctx.closePath();
    ctx.fillStyle = fill; ctx.fill();
    ctx.strokeStyle = '#0d0a07'; ctx.lineWidth = 3; ctx.stroke();
    ctx.save(); ctx.translate(cx, cy); ctx.rotate(start + sliceAngle / 2);
    ctx.textAlign = 'right'; ctx.fillStyle = textColor;
    ctx.font = "bold 15px 'DM Mono', monospace";
    ctx.fillText(EMOJIS[i] + ' ' + name, r - 16, 6);
    ctx.restore();
  });
  ctx.beginPath(); ctx.arc(cx, cy, 22, 0, 2 * Math.PI);
  ctx.fillStyle = '#c9973a'; ctx.fill();
  ctx.strokeStyle = '#0d0a07'; ctx.lineWidth = 3; ctx.stroke();
  ctx.fillStyle = '#0d0a07'; ctx.font = "bold 11px 'DM Mono', monospace";
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('TW', cx, cy);
}

function spinWheel(barIdx) {
  if (wheelSpinning) return;
  wheelSpinning = true;
  document.getElementById('spin-btn').disabled = true;
  const n = state.players.length;
  const sliceAngle = (2 * Math.PI) / n;
  const winnerIdx = Math.floor(Math.random() * n);
  const challenge = CHALLENGES[Math.floor(Math.random() * CHALLENGES.length)];
  pendingResult = { playerIdx: winnerIdx, challenge, barIdx };

  const currentNorm = ((wheelAngle % (2*Math.PI)) + 2*Math.PI) % (2*Math.PI);
  const targetCenter = ((-(winnerIdx * sliceAngle + sliceAngle/2)) % (2*Math.PI) + 2*Math.PI) % (2*Math.PI);
  const diff = ((targetCenter - currentNorm) + 2*Math.PI) % (2*Math.PI);
  const extraSpins = (5 + Math.floor(Math.random()*4)) * 2 * Math.PI;
  const targetAngle = wheelAngle + extraSpins + diff;
  const duration = 4200;
  const start = performance.now();
  const startAngle = wheelAngle;
  function ease(t) { return t < 0.5 ? 4*t*t*t : 1-Math.pow(-2*t+2,3)/2; }
  function animate(now) {
    const t = Math.min((now-start)/duration, 1);
    wheelAngle = startAngle + (targetAngle-startAngle)*ease(t);
    drawWheel(wheelAngle);
    if (t < 1) { requestAnimationFrame(animate); }
    else {
      wheelAngle = targetAngle; wheelSpinning = false;
      document.getElementById('spin-btn').disabled = false;
      showChallengeModal(winnerIdx, challenge);
    }
  }
  requestAnimationFrame(animate);
}

function showChallengeModal(playerIdx, challenge) {
  document.getElementById('modal-emoji').textContent = EMOJIS[playerIdx] || 'üéâ';
  document.getElementById('modal-name').textContent = state.players[playerIdx];
  const diffEl = document.getElementById('modal-difficulty');
  diffEl.textContent = DIFF_LABEL[challenge.diff];
  diffEl.style.color = DIFF_COLOR[challenge.diff];
  document.getElementById('modal-pts-badge').textContent = `+${challenge.pts} poeng`;
  document.getElementById('modal-challenge').textContent = challenge.emoji + '  ' + challenge.text;
  document.getElementById('result-modal').classList.add('open');
}

function setBarRating(bi, pi, val) {
  state.barRatings[bi][pi] = val;
  save();
  const container = document.getElementById(`brating-${bi}-${pi}`);
  if (container) container.querySelectorAll('.rating-star').forEach((s, i) => s.classList.toggle('filled', i < val));
  const numEl = document.getElementById(`bratingnum-${bi}-${pi}`);
  if (numEl) numEl.textContent = val;
}

function recordResult(done) {
  if (!pendingResult) return;
  const { playerIdx, challenge, barIdx } = pendingResult;
  state.challengeLog.push({
    barIdx,
    playerIdx,
    emoji: challenge.emoji,
    text: challenge.text,
    pts: challenge.pts,
    done,
  });
  save();
  pendingResult = null;
  document.getElementById('result-modal').classList.remove('open');
  // Refresh bars if visible
  const activeTab = document.querySelector('.tab.active');
  const tabs = Array.from(document.querySelectorAll('.tab'));
  const idx = tabs.indexOf(activeTab);
  if (idx === 0) renderBars();
  if (idx === 1) renderScore();
}

// ---- MAP ----
function renderMap() {
  const el = document.getElementById('tab-map');
  let html = `<p style="font-size:0.7rem;color:var(--muted);margin-bottom:16px">Trykk p√• en bar for √• √•pne Google Maps.</p>`;
  BARS.forEach((bar, bi) => {
    const v = state.visited[bi];
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(bar.name+' '+bar.addr+' Tonsberg')}`;
    html += `<a class="map-btn" href="${mapsUrl}" target="_blank" style="${v?'opacity:0.5':''}">
      <span class="map-icon">${v?'‚úÖ':'üìç'}</span>
      <div class="map-info">
        <div class="map-title" style="font-family:'Playfair Display',serif;font-style:italic">${bar.name}</div>
        <div class="map-sub">${bar.addr}</div>
      </div>
      <span style="color:var(--muted);font-size:0.8rem;margin-left:auto">‚Üí</span>
    </a>`;
  });
  const nextUnvisited = BARS.findIndex((_, bi) => !state.visited[bi]);
  if (nextUnvisited !== -1) {
    const bar = BARS[nextUnvisited];
    const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${bar.lat},${bar.lng}&travelmode=walking`;
    html += `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <div style="font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">Neste stopp</div>
      <a class="map-btn" href="${navUrl}" target="_blank" style="background:var(--gold);color:var(--bg);border-color:var(--gold)">
        <span class="map-icon">üß≠</span>
        <div class="map-info">
          <div class="map-title" style="color:var(--bg);font-family:'Playfair Display',serif;font-style:italic">Naviger til ${bar.name}</div>
          <div class="map-sub" style="color:rgba(0,0,0,0.5)">G√• dit</div>
        </div>
      </a>
    </div>`;
  }
  el.innerHTML = html;
}

// ---- SETTINGS ----
function renderSettings() {
  const el = document.getElementById('tab-settings');
  el.innerHTML = `
    <div class="settings-section">
      <div class="settings-title">Deltakernavn</div>
      ${state.players.map((p, i) => `
        <div class="player-input-row">
          <span style="font-size:1.2rem">${EMOJIS[i]}</span>
          <input type="text" id="p${i}" value="${p}" placeholder="Spiller ${i+1}">
        </div>
      `).join('')}
      <button class="save-btn" onclick="savePlayers()">Lagre navn</button>
    </div>
    <div class="settings-section">
      <div class="settings-title">Reset</div>
      <p style="font-size:0.7rem;color:var(--muted);margin-bottom:12px">Nullstill alle scores og bes√∏k for nytt l√∏p.</p>
      <button class="reset-btn" onclick="resetAll()">üóëÔ∏è Nullstill alt</button>
    </div>
  `;
}

function savePlayers() {
  state.players = [0,1,2].map(i => document.getElementById('p'+i).value.trim() || `Spiller ${i+1}`);
  save();
  alert('Navn lagret! üéâ');
}

function resetAll() {
  if (confirm('Er du sikker? Dette sletter alle scores og bes√∏k.')) {
    state.visited = BARS.map(() => false);
    state.challengeLog = [];
    state.barRatings = BARS.map(() => [null, null, null]);
    save();
    showTab('bars');
    alert('Nullstilt! Klar for nytt l√∏p üç∫');
  }
}

renderBars();
</script>
</body>
</html>
